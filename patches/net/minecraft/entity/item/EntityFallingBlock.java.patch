--- ../src-base/minecraft/net/minecraft/entity/item/EntityFallingBlock.java
+++ ../src-work/minecraft/net/minecraft/entity/item/EntityFallingBlock.java
@@ -30,6 +30,10 @@
 import net.minecraft.util.math.Vec3d;
 import net.minecraft.world.World;
 
+import carpet.CarpetSettings;
+import carpet.logging.logHelpers.TrajectoryLogHelper;
+import carpet.logging.LoggerRegistry;
+
 public class EntityFallingBlock extends Entity
 {
     private IBlockState field_175132_d;
@@ -39,9 +43,24 @@
     private boolean field_145809_g;
     private int field_145815_h = 40;
     private float field_145816_i = 2.0F;
+
+    //CM
+    private int iceCount = 0;
+
     public NBTTagCompound field_145810_d;
     protected static final DataParameter<BlockPos> field_184532_d = EntityDataManager.<BlockPos>func_187226_a(EntityFallingBlock.class, DataSerializers.field_187200_j);
+    
+    // ----- Carpet Start ----- //
+    private TrajectoryLogHelper logHelper = null;
 
+    @Override
+    public void func_70106_y() {
+        if (LoggerRegistry.__fallingBlocks && logHelper != null)
+            logHelper.onFinish();
+        super.func_70106_y();
+    }
+    // ----- Carpet End ----- //
+
     public EntityFallingBlock(World p_i1706_1_)
     {
         super(p_i1706_1_);
@@ -61,12 +80,18 @@
         this.field_70167_r = p_i45848_4_;
         this.field_70166_s = p_i45848_6_;
         this.func_184530_a(new BlockPos(this));
+        // CM
+        this.iceCount = 0;
+        if (LoggerRegistry.__fallingBlocks)
+            logHelper = new TrajectoryLogHelper("fallingBlocks");
     }
 
     public boolean func_70075_an()
     {
         return false;
     }
+    //CM
+    public String cm_name() { return "Falling Block"; }
 
     public void func_184530_a(BlockPos p_184530_1_)
     {
@@ -90,6 +115,11 @@
 
     public void func_70071_h_()
     {
+        // ----- Carpet Start ----- //
+        if (LoggerRegistry.__fallingBlocks && logHelper != null)
+            logHelper.onTick(field_70165_t, field_70163_u, field_70161_v, field_70159_w, field_70181_x, field_70179_y);
+        // ----- Carpet End ----- //
+
         Block block = this.field_175132_d.func_177230_c();
 
         if (this.field_175132_d.func_185904_a() == Material.field_151579_a)
@@ -122,29 +152,65 @@
                 this.field_70181_x -= 0.03999999910593033D;
             }
 
-            this.func_70091_d(MoverType.SELF, this.field_70159_w, this.field_70181_x, this.field_70179_y);
+            // Optimized TNT movement skipping the move code given its expensive if identical tnt movement is done. CARPET-XCOM
+            if(!CarpetSettings.fallingMovementOptimization) {
+                this.func_70091_d(MoverType.SELF, this.field_70159_w, this.field_70181_x, this.field_70179_y);
+            } else {
+                if(!cacheMatching()) {
+                    cache[0] = field_70165_t;
+                    cache[1] = field_70163_u;
+                    cache[2] = field_70161_v;
+                    cache[3] = field_70159_w;
+                    cache[4] = field_70181_x;
+                    cache[5] = field_70179_y;
+                    cacheTime = func_184102_h().func_71259_af();
+                    this.func_70091_d(MoverType.SELF, this.field_70159_w, this.field_70181_x, this.field_70179_y);
+                    if (!field_70128_L) {
+                        cache[6] = field_70165_t;
+                        cache[7] = field_70163_u;
+                        cache[8] = field_70161_v;
+                        cache[9] = field_70159_w;
+                        cache[10] = field_70181_x;
+                        cache[11] = field_70179_y;
+                        cacheBool[0] = field_70134_J;
+                        cacheBool[1] = field_70122_E;
+                    } else {
+                        cache[0] = Integer.MAX_VALUE;
+                    }
+                } else {
+                    this.func_70107_b(cache[6], cache[7], cache[8]);
+                    field_70159_w = cache[9];
+                    field_70181_x = cache[10];
+                    field_70179_y = cache[11];
+                    field_70134_J = cacheBool[0];
+                    field_70122_E = cacheBool[1];
+                }
+            }
 
+            //Fix falling blocks duplication when going through portals. CARPET-XCOM
+            if(CarpetSettings.duplicationFixGravityBlocks && field_70128_L) return;
+            
             if (!this.field_70170_p.field_72995_K)
             {
-                BlockPos blockpos1 = new BlockPos(this);
-                boolean flag = this.field_175132_d.func_177230_c() == Blocks.field_192444_dS;
-                boolean flag1 = flag && this.field_70170_p.func_180495_p(blockpos1).func_185904_a() == Material.field_151586_h;
+                BlockPos curPos = new BlockPos(this);
+                boolean concrete = this.field_175132_d.func_177230_c() == Blocks.field_192444_dS;
+                boolean concreteInWater = concrete && this.field_70170_p.func_180495_p(curPos).func_185904_a() == Material.field_151586_h;
                 double d0 = this.field_70159_w * this.field_70159_w + this.field_70181_x * this.field_70181_x + this.field_70179_y * this.field_70179_y;
 
-                if (flag && d0 > 1.0D)
+                if (concrete && d0 > 1.0D)
                 {
                     RayTraceResult raytraceresult = this.field_70170_p.func_72901_a(new Vec3d(this.field_70169_q, this.field_70167_r, this.field_70166_s), new Vec3d(this.field_70165_t, this.field_70163_u, this.field_70161_v), true);
 
                     if (raytraceresult != null && this.field_70170_p.func_180495_p(raytraceresult.func_178782_a()).func_185904_a() == Material.field_151586_h)
                     {
-                        blockpos1 = raytraceresult.func_178782_a();
-                        flag1 = true;
+                        curPos = raytraceresult.func_178782_a();
+                        concreteInWater = true;
                     }
                 }
 
-                if (!this.field_70122_E && !flag1)
+                if (!this.field_70122_E && !concreteInWater)
                 {
-                    if (this.field_145812_b > 100 && !this.field_70170_p.field_72995_K && (blockpos1.func_177956_o() < 1 || blockpos1.func_177956_o() > 256) || this.field_145812_b > 600)
+                    if (this.field_145812_b > 100 && !this.field_70170_p.field_72995_K && (curPos.func_177956_o() < 1 || curPos.func_177956_o() > 256) || this.field_145812_b > 600)
                     {
                         if (this.field_145813_c && this.field_70170_p.func_82736_K().func_82766_b("doEntityDrops"))
                         {
@@ -156,9 +222,9 @@
                 }
                 else
                 {
-                    IBlockState iblockstate = this.field_70170_p.func_180495_p(blockpos1);
+                    IBlockState curState = this.field_70170_p.func_180495_p(curPos);
 
-                    if (!flag1 && BlockFalling.func_185759_i(this.field_70170_p.func_180495_p(new BlockPos(this.field_70165_t, this.field_70163_u - 0.009999999776482582D, this.field_70161_v))))
+                    if (!concreteInWater && BlockFalling.func_185759_i(this.field_70170_p.func_180495_p(new BlockPos(this.field_70165_t, this.field_70163_u - 0.009999999776482582D, this.field_70161_v))))
                     {
                         this.field_70122_E = false;
                         return;
@@ -168,22 +234,42 @@
                     this.field_70179_y *= 0.699999988079071D;
                     this.field_70181_x *= -0.5D;
 
-                    if (iblockstate.func_177230_c() != Blocks.field_180384_M)
+                    if (block == Blocks.field_150467_bQ &&
+                            CarpetSettings.renewablePackedIce &&
+                            this.field_70170_p.func_180495_p(new BlockPos(this.field_70165_t, this.field_70163_u - 0.059999999776482582D, this.field_70161_v)).func_177230_c()==Blocks.field_150432_aD  )
                     {
+                        if (iceCount < 2)
+                        {
+                            field_70170_p.func_175655_b(curPos.func_177977_b(), false);
+                            this.field_70122_E = false;
+                            iceCount++;
+                            return;
+                        }
+                        else
+                        {
+                            field_70170_p.func_180501_a(curPos.func_177977_b(),Blocks.field_150403_cj.func_176223_P(),3);
+                            field_70170_p.func_175718_b(2001,curPos.func_177977_b(),Block.func_149682_b(Blocks.field_150403_cj));
+                        }
+                    }
+
+                    if (curState.func_177230_c() != Blocks.field_180384_M)
+                    {
                         this.func_70106_y();
 
                         if (!this.field_145808_f)
                         {
-                            if (this.field_70170_p.func_190527_a(block, blockpos1, true, EnumFacing.UP, (Entity)null) && (flag1 || !BlockFalling.func_185759_i(this.field_70170_p.func_180495_p(blockpos1.func_177977_b()))) && this.field_70170_p.func_180501_a(blockpos1, this.field_175132_d, 3))
+                            if (this.field_70170_p.func_190527_a(block, curPos, true, EnumFacing.UP, (Entity)null)
+                                    && (concreteInWater || !BlockFalling.func_185759_i(this.field_70170_p.func_180495_p(curPos.func_177977_b())))
+                                    && this.field_70170_p.func_180501_a(curPos, this.field_175132_d, 3))
                             {
                                 if (block instanceof BlockFalling)
                                 {
-                                    ((BlockFalling)block).func_176502_a_(this.field_70170_p, blockpos1, this.field_175132_d, iblockstate);
+                                    ((BlockFalling)block).func_176502_a_(this.field_70170_p, curPos, this.field_175132_d, curState);
                                 }
 
                                 if (this.field_145810_d != null && block instanceof ITileEntityProvider)
                                 {
-                                    TileEntity tileentity = this.field_70170_p.func_175625_s(blockpos1);
+                                    TileEntity tileentity = this.field_70170_p.func_175625_s(curPos);
 
                                     if (tileentity != null)
                                     {
@@ -211,7 +297,7 @@
                         }
                         else if (block instanceof BlockFalling)
                         {
-                            ((BlockFalling)block).func_190974_b(this.field_70170_p, blockpos1);
+                            ((BlockFalling)block).func_190974_b(this.field_70170_p, curPos);
                         }
                     }
                 }
@@ -356,4 +442,12 @@
     {
         return true;
     }
+
+    // Optimization methods CARPET-XCOM
+    private static double[] cache = new double[12];
+    private static boolean[] cacheBool = new boolean[2];
+    private static long cacheTime = 0;
+    private boolean cacheMatching() {
+        return cache[0] == field_70165_t && cache[1] == field_70163_u && cache[2] == field_70161_v && cache[3] == field_70159_w && cache[4] == field_70181_x && cache[5] == field_70179_y && cacheTime == func_184102_h().func_71259_af();
+    }
 }
